kind: "Dashboard"
metadata:
  name: query-statistics-enhanced
  createdAt: 0001-01-01T00:00:00Z
  updatedAt: 0001-01-01T00:00:00Z
  version: 0
  project: vllm
spec:
  display:
    name: vLLM Query Statistics ENHANCED

  variables:
    - kind: ListVariable
      spec:
        display:
          name: Model
          hidden: false
        name: model_name
        allowAllValue: true
        allowMultiple: true
        defaultValue:
          - $__all
        sort: alphabetical-asc
        plugin:
          kind: PrometheusLabelValuesVariable
          spec:
            datasource:
              kind: PrometheusDatasource
              name: prometheus
            labelName: model_name
            matchers:
              - vllm:generation_tokens_total{}

  panels:
    # ===== OVERVIEW STATS =====
    "running_now":
      kind: Panel
      spec:
        display:
          name: Running Requests
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum(vllm:num_requests_running{model_name=~"$model_name"})

    "waiting_now":
      kind: Panel
      spec:
        display:
          name: Waiting Requests
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum(vllm:num_requests_waiting{model_name=~"$model_name"})

    "kv_cache_now":
      kind: Panel
      spec:
        display:
          name: KV Cache Usage (%)
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: avg(vllm:kv_cache_usage_perc{model_name=~"$model_name"}) * 100

    "total_requests":
      kind: Panel
      spec:
        display:
          name: Total Completed Requests (5m)
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum(increase(vllm:request_success_total{model_name=~"$model_name"}[$__range]))

    # ===== REQUEST STATE OVER TIME =====
    "running_over_time":
      kind: Panel
      spec:
        display:
          name: Running Requests Over Time
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (model_name) (vllm:num_requests_running{model_name=~"$model_name"})
                  seriesNameFormat: '{{model_name}}'

    "waiting_over_time":
      kind: Panel
      spec:
        display:
          name: Waiting Requests Over Time
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (model_name) (vllm:num_requests_waiting{model_name=~"$model_name"})
                  seriesNameFormat: '{{model_name}}'

    "kv_cache_over_time":
      kind: Panel
      spec:
        display:
          name: KV Cache Usage (%) Over Time
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: avg by (model_name) (vllm:kv_cache_usage_perc{model_name=~"$model_name"}) * 100
                  seriesNameFormat: '{{model_name}}'

    # ===== REQUEST RATE & SUCCESS =====
    "request_rate":
      kind: Panel
      spec:
        display:
          name: Request Rate (req/sec)
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (model_name) (rate(vllm:request_success_total{model_name=~"$model_name"}[$__interval]))
                  seriesNameFormat: '{{model_name}}'

    "request_success_by_model":
      kind: Panel
      spec:
        display:
          name: Completed Requests by Model
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (model_name) (rate(vllm:request_success_total{model_name=~"$model_name"}[$__interval]))
                  seriesNameFormat: '{{model_name}}'

    # ===== LATENCY METRICS =====
    "latency_p50":
      kind: Panel
      spec:
        display:
          name: E2E Latency P50
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: seconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    histogram_quantile(
                      0.50,
                      sum by (le) (
                        rate(vllm:e2e_request_latency_seconds_bucket{model_name=~"$model_name"}[$__interval])
                      )
                    )

    "latency_p95":
      kind: Panel
      spec:
        display:
          name: E2E Latency P95
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: seconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    histogram_quantile(
                      0.95,
                      sum by (le) (
                        rate(vllm:e2e_request_latency_seconds_bucket{model_name=~"$model_name"}[$__interval])
                      )
                    )

    "ttft_p50":
      kind: Panel
      spec:
        display:
          name: TTFT P50
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: seconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    histogram_quantile(
                      0.50,
                      sum by (le) (
                        rate(vllm:time_to_first_token_seconds_bucket{model_name=~"$model_name"}[$__interval])
                      )
                    )

    "ttft_p95":
      kind: Panel
      spec:
        display:
          name: TTFT P95
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
            format:
              unit: seconds
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    histogram_quantile(
                      0.95,
                      sum by (le) (
                        rate(vllm:time_to_first_token_seconds_bucket{model_name=~"$model_name"}[$__interval])
                      )
                    )

    # ===== TOKEN THROUGHPUT =====
    "input_tokens":
      kind: Panel
      spec:
        display:
          name: Input Tokens/sec
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (model_name) (rate(vllm:prompt_tokens_total{model_name=~"$model_name"}[$__interval]))
                  seriesNameFormat: '{{model_name}}'

    "output_tokens":
      kind: Panel
      spec:
        display:
          name: Output Tokens/sec
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: sum by (model_name) (rate(vllm:generation_tokens_total{model_name=~"$model_name"}[$__interval]))
                  seriesNameFormat: '{{model_name}}'

    # ===== TOKEN DISTRIBUTION =====
    "prompt_tokens_hist":
      kind: Panel
      spec:
        display:
          name: Prompt Token Distribution
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    sum(increase(vllm:request_prompt_tokens_sum{model_name=~"$model_name"}[$__range]))
                    /
                    sum(increase(vllm:request_prompt_tokens_count{model_name=~"$model_name"}[$__range]))
                  seriesNameFormat: 'Avg prompt tokens'

    "generation_tokens_hist":
      kind: Panel
      spec:
        display:
          name: Generation Token Distribution
        plugin:
          kind: TimeSeriesChart
          spec:
            legend:
              mode: table
              position: bottom
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    sum(increase(vllm:request_generation_tokens_sum{model_name=~"$model_name"}[$__range]))
                    /
                    sum(increase(vllm:request_generation_tokens_count{model_name=~"$model_name"}[$__range]))
                  seriesNameFormat: 'Avg generation tokens'

    # ===== REQUEST SIZING =====
    "prompt_tokens_p95":
      kind: Panel
      spec:
        display:
          name: Prompt Tokens (P95)
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    histogram_quantile(
                      0.95,
                      sum by (le) (
                        rate(vllm:request_prompt_tokens_bucket{model_name=~"$model_name"}[$__interval])
                      )
                    )

    "generation_tokens_p95":
      kind: Panel
      spec:
        display:
          name: Generation Tokens (P95)
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    histogram_quantile(
                      0.95,
                      sum by (le) (
                        rate(vllm:request_generation_tokens_bucket{model_name=~"$model_name"}[$__interval])
                      )
                    )

    "max_generation_tokens_p95":
      kind: Panel
      spec:
        display:
          name: Max Generation Tokens (P95)
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    histogram_quantile(
                      0.95,
                      sum by (le) (
                        rate(vllm:request_max_num_generation_tokens_bucket{model_name=~"$model_name"}[$__interval])
                      )
                    )

    "params_max_tokens_p95":
      kind: Panel
      spec:
        display:
          name: Request Max Tokens (P95)
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    histogram_quantile(
                      0.95,
                      sum by (le) (
                        rate(vllm:request_params_max_tokens_bucket{model_name=~"$model_name"}[$__interval])
                      )
                    )

    "params_n_avg":
      kind: Panel
      spec:
        display:
          name: Request Params n (Avg)
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    sum(rate(vllm:request_params_n_sum{model_name=~"$model_name"}[$__interval]))
                    /
                    sum(rate(vllm:request_params_n_count{model_name=~"$model_name"}[$__interval]))

    "prefill_kv_tokens_avg":
      kind: Panel
      spec:
        display:
          name: Prefill KV Computed Tokens (Avg)
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    sum(rate(vllm:request_prefill_kv_computed_tokens_sum{model_name=~"$model_name"}[$__interval]))
                    /
                    sum(rate(vllm:request_prefill_kv_computed_tokens_count{model_name=~"$model_name"}[$__interval]))

    "iteration_tokens_avg":
      kind: Panel
      spec:
        display:
          name: Iteration Tokens (Avg)
        plugin:
          kind: StatChart
          spec:
            calculation: last-number
        queries:
          - kind: TimeSeriesQuery
            spec:
              plugin:
                kind: PrometheusTimeSeriesQuery
                spec:
                  datasource:
                    kind: PrometheusDatasource
                    name: prometheus
                  query: |
                    sum(rate(vllm:iteration_tokens_total_sum{model_name=~"$model_name"}[$__interval]))
                    /
                    sum(rate(vllm:iteration_tokens_total_count{model_name=~"$model_name"}[$__interval]))

  layouts:
    - kind: Grid
      spec:
        display:
          title: Overview
        items:
          - x: 0
            y: 0
            width: 6
            height: 3
            content: { $ref: '#/spec/panels/running_now' }
          - x: 6
            y: 0
            width: 6
            height: 3
            content: { $ref: '#/spec/panels/waiting_now' }
          - x: 12
            y: 0
            width: 6
            height: 3
            content: { $ref: '#/spec/panels/kv_cache_now' }
          - x: 18
            y: 0
            width: 6
            height: 3
            content: { $ref: '#/spec/panels/total_requests' }

    - kind: Grid
      spec:
        display:
          title: Request State Over Time
        items:
          - x: 0
            y: 3
            width: 8
            height: 6
            content: { $ref: '#/spec/panels/running_over_time' }
          - x: 8
            y: 3
            width: 8
            height: 6
            content: { $ref: '#/spec/panels/waiting_over_time' }
          - x: 16
            y: 3
            width: 8
            height: 6
            content: { $ref: '#/spec/panels/kv_cache_over_time' }

    - kind: Grid
      spec:
        display:
          title: Request Rate & Success
        items:
          - x: 0
            y: 9
            width: 12
            height: 6
            content: { $ref: '#/spec/panels/request_rate' }
          - x: 12
            y: 9
            width: 12
            height: 6
            content: { $ref: '#/spec/panels/request_success_by_model' }

    - kind: Grid
      spec:
        display:
          title: Latency Percentiles
        items:
          - x: 0
            y: 15
            width: 6
            height: 3
            content: { $ref: '#/spec/panels/latency_p50' }
          - x: 6
            y: 15
            width: 6
            height: 3
            content: { $ref: '#/spec/panels/latency_p95' }
          - x: 12
            y: 15
            width: 6
            height: 3
            content: { $ref: '#/spec/panels/ttft_p50' }
          - x: 18
            y: 15
            width: 6
            height: 3
            content: { $ref: '#/spec/panels/ttft_p95' }

    - kind: Grid
      spec:
        display:
          title: Token Throughput
        items:
          - x: 0
            y: 18
            width: 12
            height: 6
            content: { $ref: '#/spec/panels/input_tokens' }
          - x: 12
            y: 18
            width: 12
            height: 6
            content: { $ref: '#/spec/panels/output_tokens' }

    - kind: Grid
      spec:
        display:
          title: Token Distribution
        items:
          - x: 0
            y: 24
            width: 12
            height: 6
            content: { $ref: '#/spec/panels/prompt_tokens_hist' }
          - x: 12
            y: 24
            width: 12
            height: 6
            content: { $ref: '#/spec/panels/generation_tokens_hist' }

    - kind: Grid
      spec:
        display:
          title: Request Sizing
        items:
          - x: 0
            y: 30
            width: 4
            height: 3
            content: { $ref: '#/spec/panels/prompt_tokens_p95' }
          - x: 4
            y: 30
            width: 4
            height: 3
            content: { $ref: '#/spec/panels/generation_tokens_p95' }
          - x: 8
            y: 30
            width: 4
            height: 3
            content: { $ref: '#/spec/panels/max_generation_tokens_p95' }
          - x: 12
            y: 30
            width: 4
            height: 3
            content: { $ref: '#/spec/panels/params_max_tokens_p95' }
          - x: 16
            y: 30
            width: 4
            height: 3
            content: { $ref: '#/spec/panels/params_n_avg' }
          - x: 20
            y: 30
            width: 4
            height: 3
            content: { $ref: '#/spec/panels/prefill_kv_tokens_avg' }
          - x: 0
            y: 33
            width: 6
            height: 3
            content: { $ref: '#/spec/panels/iteration_tokens_avg' }
